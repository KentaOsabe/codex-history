# Requirements Document

## Project Description (Input)
Issue #19

## Requirements
## 背景
- フロントエンドから Rails API（`/api/sessions` 周辺）へアクセスする際、型安全で共通化されたクライアント層が存在しないため、機能追加ごとにフェッチ処理やエラー判定が分散するリスクがある。citeturn0github__get_issue0
- `docs/api_sessions.md` などの仕様に沿って、一覧・詳細・再インデックス API の I/F を早期に固めておくことで、以降の UI 実装を TDD で進めやすくする。

## スコープ
### 含めるもの
- セッション一覧 (`GET /api/sessions`)、詳細 (`GET /api/sessions/:id`)、リフレッシュ関連 (`POST /api/sessions/refresh`, `GET /api/sessions/refresh/:job_id`) を型で表現し、クライアント経由で呼び出せるようにする。
- API 呼び出しを共通化するフェッチラッパー（タイムアウト・再試行・JSON パース・エラー共通処理）と、レスポンス正規化ユーティリティの実装。
- 正常系および 4xx/5xx・ネットワークエラーをカスタム例外にマッピングし、呼び出し側が制御しやすい契約を整備。
- MSW などを使ったユニットテストで、TDD（Red→Green→Refactor）手順に沿って挙動を保証する。

### 含めないもの
- UI コンポーネントの実装や SWR/React Query のような状態管理レイヤー。
- WebSocket やストリーミング API など、Issue #19 で言及されていない追加エンドポイント。
- キャッシュ永続化やエラートースト表示など、プレゼンテーション層の責務。

## ユースケース
1. フロントエンドがセッション一覧を日付・スピーカー・検索語でフィルタし、ページネーション付きで取得する。
2. 任意セッションの詳細を取得し、サニタイズ済みバリアントの有無やツール呼び出し情報を含む正規化メッセージを受け取る。
3. 手動でインデックス再構築をリクエストし、ジョブステータスをポーリングして完了またはエラーを検知する。
4. API 呼び出しが 4xx, 5xx, ネットワーク断になった際、呼び出し元が例外タイプを分岐し適切にリカバリできる。

## 機能要件
### 型定義とパラメータ
- クライアントは TypeScript の型で各エンドポイントを表現する。必須/任意パラメータ、列挙値（例: `sort`, `speaker`）はリテラル型またはユニオンで表現し、不正値は型レベルで弾く。
- セッション一覧レスポンスは `data` 配列と `meta` オブジェクトを保持する。`meta.total_pages`, `meta.total_count`, `meta.filters` など API ドキュメント記載項目を型で表現する。
- セッション詳細レスポンスは、`attributes.messages[]` の各セグメント（role, source_type, tool_call など）を TypeScript の discriminated union として表現し、サニタイズ有無を `variant` か属性で判定できるようにする。
- リフレッシュ API は 202 (Accepted) 応答を想定し、ジョブ ID・キュー名・タイムスタンプを含む型を用意する。

### フェッチラッパー設計
- 既存の `fetcher` を拡張または置換し、以下を満たす共通関数（例: `apiClient.request`）を提供する:
  - リクエストタイムアウト（デフォルト 10 秒など）と再試行ロジック（idempotent GET に限定）を設定できる。
  - `env.apiBaseUrl` に応じて絶対 URL を解決し、`Content-Type` / `Accept` ヘッダを付与する。
  - JSON 以外（ファイルダウンロード等）は将来拡張できる構造だが、本 Issue では JSON 専用で良い。

### レスポンス正規化
- API の `data` / `meta` / `errors` 形式をクライアントで受け取り、必要最小限の再構成を行う（例: camelCase 変換は行わず API 準拠のキーを維持）。
- 日付文字列は `Date` ではなく `string` のまま返却し、UI 側が変換する。
- メッセージセグメント中の `tool_call` や `tool_result` は存在しない場合 `undefined` にし、UI 側で条件付きレンダリングしやすくする。

### エラー処理
- ステータスコードに応じたカスタムエラー（例: `ApiClientError`, `ApiServerError`, `ApiNetworkError`, `ApiTimeoutError`）を定義し、HTTP レスポンスの `errors[]` 配列や `meta.invalid_fields` を保持する。
- API が JSON 以外を返却した場合は `ApiUnexpectedResponseError`（想定外レスポンス）として扱い、デバッグ情報（HTTP status, body snippet）を格納する。
- リトライ後も失敗した場合は最終例外をそのまま投げる。

## 非機能要件
- TypeScript Strict オプションでビルドが通ること。
- フロントエンドでの回帰を避けるため、既存テスト（`frontend/src/api/client.test.ts` など）がすべて通る状態を維持しつつ新テストを追加する。
- コードは TDD 手順に従って開発し、テストケースには目的コメント（既存テストと同様の書き方）を付与する。
- API 呼び出しユーティリティは tree-shakeable で、副作用を持たない関数として実装する。

## テスト要件
- MSW で API をモックし、成功/失敗レスポンスのシナリオを再現する。テストファイル内には各ケースの目的コメントを記載する。
- 最低限以下のケースをカバーする:
  - 一覧取得成功とページネーションメタの受け取り。
  - フィルタ適用時（`speaker`, `start_date`, `end_date`, `q`）にクエリが正しく生成されること。
  - 詳細取得でサニタイズ版指定時の挙動と、サニタイズ未提供時のエラー変換。
  - リフレッシュ API で 202 レスポンスを受けた際のジョブ情報整形。
  - 400/422 レスポンスの `invalid_fields` 取り出しと例外化。
  - 500 系レスポンス・ネットワーク失敗・タイムアウト時に適切な例外が投げられること。
- テストデータは `fixtures/` 内の JSONL を直接読むのではなく、MSW のレスポンスで再現する。

## 移行・互換性
- 既存の `fetcher` を利用している箇所（現状テストのみ）に影響が出る場合、後方互換 API を提供するか、影響範囲を明記して一括置換する。
- 今後 `GET /api/search` などに拡張できるよう、エンドポイント追加が容易な構造（例: `apiClient.sessions.list`, `apiClient.sessions.show`）にする。

## 未決定事項 / 要確認
- リトライ回数・タイムアウト値のデフォルト（暫定実装: GET 10 秒 / リトライ 1 回、POST 15 秒 / リトライなし）。最終値はプロダクトオーナーと合意する。
- 429 (Too Many Requests) 等のレート制限レスポンスをどう扱うか（専用例外を用意するか汎用クライアントエラーで扱うか）。
- クライアントでのロギング方針（console, Sentry など）をこの層で行うか、呼び出し側に委任するか。
