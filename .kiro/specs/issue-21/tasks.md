# Implementation Plan

- [ ] 1. ルーティング基盤とセッション詳細への導線を構築する
  - `RouterProvider` ベースのルート定義を追加し、トップ一覧とセッション詳細を URL で切り替えられるようにする
  - データフェッチ中・存在しないセッション・API エラー時の共通エラーハンドリングをルーター層で扱い、戻る／再試行経路を提供する
  - 既存の日付別一覧が新ルート下でも同じ振る舞いになるようステート持続や初期ロード手順を再確認する
  - _Requirements: R1_

- [ ] 1.1 ナビゲーションフックを整備して一覧から詳細へ遷移できるようにする
  - `navigateToSessionDetail` プレースホルダーを置き換え、選択したセッション ID をルーターへ渡す Hook を実装する
  - 遷移直前に選択カードのフォーカスやキーボード操作を維持し、アクセシビリティを損なわないよう配慮する
  - 直接 URL アクセス時にもセッション ID を受け取れるよう、必要に応じてリンクや共有 URL を更新する
  - _Requirements: R1_

- [ ] 2. セッション詳細取得と状態管理のビューモデルを実装する
  - `sessionsApi.getSessionDetail` を利用し、sessionId と variant に基づいてデータを取得するビューモデルを用意する
  - ローディング・成功・失敗の各状態とエラー内容を保持し、UI コンポーネントへ渡すプロパティを定義する
  - API レスポンスをロール別のタイムライン表示に適した形へ整形し、メタ情報や統計値もまとめる
  - _Requirements: R1_

- [ ] 2.1 バリアント切替とスクロールアンカーの維持を扱う
  - original/sanitized のトグル状態を管理し、選択肢に応じてリクエストパラメータを変える
  - サニタイズ版が存在しない場合は UI で切替不可を示し、不要な API 呼び出しを防止する
  - 取得し直す際にスクロールアンカーを保存・復元し、長文でも視点が飛ばないようにする
  - _Requirements: R1, R2, R3_

- [ ] 3. セッション詳細ページのレイアウトとヘッダー情報を実装する
  - タイトル、日付、メッセージ数、ツール呼び出し数、reasoning 数などの統計値をまとめて表示する
  - variant 切替 UI やダウンロードリンクなどの補助アクションをヘッダーに配置し、状態に応じて有効／無効を切り替える
  - メタ情報やエラーアラートを表示できる情報バーを追加し、API 由来の詳細メッセージを反映する
  - _Requirements: R1_

- [ ] 3.1 メッセージタイムラインとカード表示を構築する
  - メッセージのタイムスタンプをローカルタイムに整形し、ロール別スタイルで本文を描画する
  - セグメントごとにチャネルやフォーマットを示すバッジを追加し、長文でも視認性を保つ
  - ツール呼び出しや結果が付随するメッセージには折りたたみ式の JSON 表示を用意する
  - _Requirements: R1_

- [ ] 3.2 暗号化 reasoning 用のプレースホルダーと告知 UI を実装する
  - `payload_type` や `raw.encrypted_content` を検知し、暗号化メッセージではプレースホルダー枠を表示する
  - ハッシュや文字数などのメタ情報を提示して内容が非表示である理由を説明し、詳細ボタンは常にマスクを維持する
  - reasoning 以外のメッセージは通常レンダリングにフォールバックし、誤検知を防ぐ
  - _Requirements: R2_

- [ ] 4. 仮想スクロールと遅延レンダリングを実装する
  - @tanstack/react-virtual を用いてメッセージリストを仮想化し、可視範囲とオーバースキャン分のみ DOM に保持する
  - 測定関数と推定高さを役割別ヒューリスティクスで定義し、可変高さメッセージでもスクロールが途切れないようにする
  - メッセージ数が閾値未満の場合は通常レンダリングにフォールバックし、オーバーヘッドを抑える
  - _Requirements: R3_

- [ ] 4.1 遅延ロードとスクロール端での読み込み制御を整備する
  - 上端／下端に到達したときの追加読み込みフックを実装し、連続スクロールでメッセージを段階取得できるようにする
  - 仮想化領域のスクロール更新時に現在のオフセットを保持し、variant 切替後も同じ位置へ復帰させる
  - ブラウザのパフォーマンスイベント（requestIdleCallback など）を利用して JSON 整形など重い処理をアイドル時へオフロードする
  - _Requirements: R3_

- [ ] 5. テストと品質保証を完了する
  - ビューモデルやスクロールアンカーなどのフックを Vitest で TDD し、API エラーやキャンセルの境界条件も網羅する
  - ページ／タイムライン／プレースホルダーのコンポーネントテストで UI 状態遷移とアクセシビリティ属性を検証する
  - MSW を使った統合テストで成功・404・500・サニタイズ有無などのシナリオを再現し、仮想スクロール DOM ノード数も検証する
  - _Requirements: R1, R2, R3, R4_

- [ ] 5.1 仮想スクロールとパフォーマンスまわりの検証を追加する
  - 大量メッセージモックでスクロール中のレンダリング数が可視範囲＋オーバースキャンに収まることを確認する
  - variant 切替後もアンカー位置とスクロールオフセットが保持されることをシナリオテストで証明する
  - Reasoning プレースホルダーが暗号化データを DOM に出力しないことをスナップショットや DOM inspect で確かめる
  - _Requirements: R2, R3, R4_
